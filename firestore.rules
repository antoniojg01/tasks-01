/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model where all user-generated data
 * is private by default. Access to any piece of data is granted only to the authenticated user who created it.
 *
 * Data Structure: All user-specific data is hierarchically nested under a top-level `users` collection.
 * The structure `/users/{userId}/{subcollection}/{documentId}` ensures that a document's path inherently
 * defines its owner, making security rules simple, fast, and secure.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isValidUserProfileCreate(userId) {
      return request.resource.data.id == userId;
    }

    function isImmutableUserProfileUpdate() {
      return !('id' in request.resource.data);
    }

    function isValidSubcollectionCreate(userId, docId) {
      return request.resource.data.userId == userId && request.resource.data.id == docId;
    }

    function isImmutableSubcollectionUpdate() {
      return !('id' in request.resource.data) && !('userId' in request.resource.data);
    }

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all users
      allow create: if isOwner(userId) && isValidUserProfileCreate(userId);
      allow update: if isExistingOwner(userId) && isImmutableUserProfileUpdate();
      allow delete: if isExistingOwner(userId);

      /**
       * @description Rules for the `tasks` subcollection.
       */
      match /tasks/{docId} {
        allow get, list, delete: if isOwner(userId);
        allow create: if isOwner(userId) && isValidSubcollectionCreate(userId, docId);
        allow update: if isExistingOwner(userId) && isImmutableSubcollectionUpdate();
      }

      /**
       * @description Rules for the `tags` subcollection.
       */
      match /tags/{docId} {
        allow get, list, delete: if isOwner(userId);
        allow create: if isOwner(userId) && isValidSubcollectionCreate(userId, docId);
        allow update: if isExistingOwner(userId) && isImmutableSubcollectionUpdate();
      }

      /**
       * @description Rules for the `periods` subcollection.
       */
      match /periods/{docId} {
        allow get, list, delete: if isOwner(userId);
        allow create: if isOwner(userId) && isValidSubcollectionCreate(userId, docId);
        allow update: if isExistingOwner(userId) && isImmutableSubcollectionUpdate();
      }
    }
  }
}
